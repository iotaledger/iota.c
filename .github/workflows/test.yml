name: dev-ci
on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  test:
    runs-on: ubuntu-18.04
    if: "! contains(toJSON(github.event.commits.*.message), '[skip-ci]')"

    steps:
    - uses: actions/checkout@v2
    - uses: jwlawson/actions-setup-cmake@v1.4
      with:
        cmake-version: '3.16.x'
  
    - name: install ninja and libcurl
      run: |
        sudo apt update
        sudo apt upgrade -y
        sudo apt install -y cppcheck ninja-build libcurl4-openssl-dev clang-format build-essential

    - name: Coding style check
      run: ./tools/ci_format_check src

    - name: Static analysis check
      run: cppcheck --force --error-exitcode=1 -q src

    - name: CMake build
      run: |
        cmake --version
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_INSTALL_PREFIX=$PWD -DIOTA_TESTS=ON -DIOTA_ASAN_ENABLED=ON ..
        ninja -v && ninja test
